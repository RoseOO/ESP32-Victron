
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Victron BLE Configuration</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: Arial, sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container { 
            max-width: 800px; 
            margin: 0 auto; 
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .header h1 { font-size: 28px; margin-bottom: 10px; }
        .header p { opacity: 0.9; }
        .content { padding: 30px; }
        .section { margin-bottom: 30px; }
        .section h2 { 
            color: #667eea; 
            margin-bottom: 15px; 
            font-size: 20px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
        .device-list { 
            border: 1px solid #ddd; 
            border-radius: 5px; 
            overflow: hidden;
        }
        .device-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.2s;
        }
        .device-item:hover { background: #f9f9f9; }
        .device-item:last-child { border-bottom: none; }
        .device-info { flex: 1; }
        .device-name { font-weight: bold; color: #333; margin-bottom: 5px; }
        .device-address { color: #666; font-size: 14px; font-family: monospace; }
        .device-key { color: #999; font-size: 12px; margin-top: 5px; }
        .device-actions button {
            margin-left: 10px;
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        .btn-edit { background: #667eea; color: white; }
        .btn-edit:hover { background: #5568d3; }
        .btn-delete { background: #e74c3c; color: white; }
        .btn-delete:hover { background: #c0392b; }
        .btn-primary {
            background: #667eea;
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.2s;
        }
        .btn-primary:hover { background: #5568d3; }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: bold;
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        .form-group small {
            display: block;
            margin-top: 5px;
            color: #666;
            font-size: 12px;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }
        .modal.active { display: flex; align-items: center; justify-content: center; }
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal-header {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #667eea;
        }
        .modal-header h3 {
            color: #667eea;
            font-size: 22px;
        }
        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }
        .btn-secondary {
            background: #95a5a6;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .btn-secondary:hover { background: #7f8c8d; }
        .info-box {
            background: #e8f4f8;
            border-left: 4px solid #667eea;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
        }
        .info-box strong { color: #667eea; }
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }
        .empty-state svg {
            width: 80px;
            height: 80px;
            margin-bottom: 20px;
            opacity: 0.5;
        }
        @media (max-width: 600px) {
            body { padding: 10px; }
            .container { border-radius: 8px; }
            .header { 
                padding: 20px 15px; 
                flex-direction: column;
                gap: 15px;
                align-items: stretch;
            }
            .header h1 { font-size: 22px; text-align: center; }
            .header p { font-size: 14px; }
            .header > div { 
                display: flex; 
                flex-direction: column;
                gap: 8px;
            }
            .header > div a {
                width: 100%;
                text-align: center;
                padding: 12px 20px;
            }
            .content { padding: 20px 15px; }
            .section h2 { font-size: 18px; }
            .device-item { 
                flex-direction: column; 
                align-items: flex-start;
                padding: 12px;
            }
            .device-actions { 
                margin-top: 10px; 
                width: 100%;
                display: flex;
                gap: 8px;
            }
            .device-actions button { 
                flex: 1;
                margin: 0;
                padding: 10px 12px;
            }
            .modal-content {
                width: 95%;
                padding: 20px;
                max-height: 85vh;
            }
            .modal-header h3 { font-size: 20px; }
            input, select, textarea {
                font-size: 16px; /* Prevents iOS zoom on input focus */
            }
            .btn-primary {
                width: 100%;
                padding: 14px 25px;
                font-size: 16px;
            }
            .modal-buttons {
                flex-direction: column;
                gap: 8px;
            }
            .modal-buttons button {
                width: 100%;
                padding: 12px 20px;
            }
            .info-box { 
                padding: 12px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Victron BLE Configuration</h1>
            <p>Configure your Victron devices and encryption keys</p>
        </div>
        
        <div class="content">
            <div class="section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="margin-bottom: 0;">Configured Devices</h2>
                    <div>
                        <a href="/debug" style="padding: 10px 20px; background: #9b59b6; color: white; text-decoration: none; border-radius: 5px; font-weight: bold; margin-right: 10px;">Debug</a>
                        <a href="/monitor" style="padding: 10px 20px; background: #667eea; color: white; text-decoration: none; border-radius: 5px; font-weight: bold;">Live Monitor</a>
                    </div>
                </div>
                <div class="info-box">
                    <strong>Note:</strong> Add your Victron devices with their BLE MAC addresses. 
                    If your device uses encryption, enter the 32-character encryption key from the VictronConnect app.
                </div>
                <div id="deviceList" class="device-list">
                    <div class="empty-state">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                            <line x1="9" y1="9" x2="15" y2="9"></line>
                            <line x1="9" y1="15" x2="15" y2="15"></line>
                        </svg>
                        <p>No devices configured yet</p>
                    </div>
                </div>
                <button class="btn-primary" onclick="openAddDeviceModal()" style="margin-top: 15px;">
                    + Add Device
                </button>
            </div>
            
            <div class="section">
                <h2>WiFi Configuration</h2>
                <div id="wifiStatus" class="info-box">
                    <strong>Current Mode:</strong> <span id="currentMode">Loading...</span><br>
                    <strong>IP Address:</strong> <span id="ipAddress">Loading...</span>
                </div>
                <button class="btn-primary" onclick="openWiFiModal()">
                    Configure WiFi
                </button>
            </div>
            
            <div class="section">
                <h2>Home Assistant / MQTT</h2>
                <div id="mqttStatus" class="info-box">
                    <strong>Status:</strong> <span id="mqttEnabled">Loading...</span><br>
                    <strong>Broker:</strong> <span id="mqttBroker">Loading...</span><br>
                    <strong>Connection:</strong> <span id="mqttConnected">Loading...</span>
                </div>
                <button class="btn-primary" onclick="openMQTTModal()">
                    Configure MQTT
                </button>
            </div>
            
            <div class="section">
                <h2>Battery Alarm (Buzzer)</h2>
                <div id="buzzerStatus" class="info-box">
                    <strong>Status:</strong> <span id="buzzerEnabled">Loading...</span><br>
                    <strong>Threshold:</strong> <span id="buzzerThreshold">Loading...</span>
                </div>
                <button class="btn-primary" onclick="openBuzzerModal()">
                    Configure Alarm
                </button>
            </div>
            
            <div class="section">
                <h2>LCD Display Settings</h2>
                <div id="lcdStatus" class="info-box">
                    <strong>Font Size:</strong> <span id="lcdFontSize">Loading...</span><br>
                    <strong>Auto-Scroll:</strong> <span id="lcdAutoScroll">Loading...</span><br>
                    <strong>Scroll Rate:</strong> <span id="lcdScrollRate">Loading...</span><br>
                    <strong>Orientation:</strong> <span id="lcdOrientation">Loading...</span><br>
                    <strong>Large Display Timeout:</strong> <span id="lcdLargeTimeout">Loading...</span>
                </div>
                <button class="btn-primary" onclick="openLCDModal()">
                    Configure Display
                </button>
            </div>
        </div>
    </div>

    <!-- Add/Edit Device Modal -->
    <div id="deviceModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Add Device</h3>
            </div>
            <form id="deviceForm">
                <div class="form-group">
                    <label>Device Name</label>
                    <input type="text" id="deviceName" placeholder="e.g., SmartShunt 500A" required>
                    <small>Friendly name for the device</small>
                </div>
                <div class="form-group">
                    <label>BLE MAC Address</label>
                    <input type="text" id="deviceAddress" placeholder="e.g., AA:BB:CC:DD:EE:FF" required pattern="[A-Fa-f0-9:]{17}">
                    <small>MAC address from VictronConnect app</small>
                </div>
                <div class="form-group">
                    <label>Encryption Key (Optional)</label>
                    <input type="text" id="deviceKey" placeholder="e.g., 0123456789ABCDEF0123456789ABCDEF" pattern="[A-Fa-f0-9]{32}">
                    <small>32-character hex key (leave empty for instant readout mode)</small>
                </div>
                <div class="modal-buttons">
                    <button type="button" class="btn-secondary" onclick="closeDeviceModal()">Cancel</button>
                    <button type="submit" class="btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- WiFi Configuration Modal -->
    <div id="wifiModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>WiFi Configuration</h3>
            </div>
            <form id="wifiForm">
                <div class="form-group">
                    <label>Mode</label>
                    <select id="wifiMode" onchange="toggleWiFiMode()">
                        <option value="ap">Access Point (AP)</option>
                        <option value="sta">Station (Connect to WiFi)</option>
                    </select>
                </div>
                <div id="staFields" style="display: none;">
                    <div class="form-group">
                        <label>WiFi SSID</label>
                        <input type="text" id="wifiSSID" placeholder="Your WiFi network name">
                    </div>
                    <div class="form-group">
                        <label>WiFi Password</label>
                        <input type="password" id="wifiPassword" placeholder="WiFi password">
                    </div>
                </div>
                <div id="apFields">
                    <div class="form-group">
                        <label>AP Password</label>
                        <input type="password" id="apPassword" placeholder="Password for AP mode">
                        <small>Minimum 8 characters</small>
                    </div>
                </div>
                <div class="info-box">
                    <strong>Warning:</strong> Changing WiFi settings requires a restart to take effect.
                </div>
                <div class="modal-buttons">
                    <button type="button" class="btn-secondary" onclick="closeWiFiModal()">Cancel</button>
                    <button type="submit" class="btn-primary">Save & Restart</button>
                </div>
            </form>
        </div>
    </div>

    <!-- MQTT Configuration Modal -->
    <div id="mqttModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>MQTT / Home Assistant Configuration</h3>
            </div>
            <form id="mqttForm">
                <div class="form-group">
                    <label>Enable MQTT</label>
                    <select id="mqttEnable">
                        <option value="false">Disabled</option>
                        <option value="true">Enabled</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>MQTT Broker Address</label>
                    <input type="text" id="mqttBrokerAddr" placeholder="e.g., 192.168.1.100 or mqtt.example.com">
                    <small>IP address or hostname of MQTT broker</small>
                </div>
                <div class="form-group">
                    <label>MQTT Port</label>
                    <input type="number" id="mqttPort" placeholder="1883" value="1883">
                </div>
                <div class="form-group">
                    <label>Username (Optional)</label>
                    <input type="text" id="mqttUsername" placeholder="MQTT username">
                </div>
                <div class="form-group">
                    <label>Password (Optional)</label>
                    <input type="password" id="mqttPassword" placeholder="Leave empty to keep current">
                </div>
                <div class="form-group">
                    <label>Base Topic</label>
                    <input type="text" id="mqttTopic" placeholder="victron" value="victron">
                    <small>Base MQTT topic for all devices</small>
                </div>
                <div class="form-group">
                    <label>Home Assistant Auto-Discovery</label>
                    <select id="mqttHA">
                        <option value="true">Enabled</option>
                        <option value="false">Disabled</option>
                    </select>
                    <small>Automatically configure devices in Home Assistant</small>
                </div>
                <div class="form-group">
                    <label>Publish Interval (seconds)</label>
                    <input type="number" id="mqttInterval" placeholder="30" value="30" min="5" max="300">
                </div>
                <div class="info-box">
                    <strong>Info:</strong> MQTT data will be published every interval. Home Assistant auto-discovery will create sensors automatically.
                </div>
                <div class="modal-buttons">
                    <button type="button" class="btn-secondary" onclick="closeMQTTModal()">Cancel</button>
                    <button type="submit" class="btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Buzzer Configuration Modal -->
    <div id="buzzerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Battery Alarm Configuration</h3>
            </div>
            <form id="buzzerForm">
                <div class="form-group">
                    <label>Enable Buzzer Alarm</label>
                    <select id="buzzerEnable">
                        <option value="false">Disabled</option>
                        <option value="true">Enabled</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Battery SOC Threshold (%)</label>
                    <input type="number" id="buzzerThresholdInput" placeholder="10" value="10" min="0" max="100" step="0.1">
                    <small>Alarm will beep when battery SOC falls below this percentage</small>
                </div>
                <div class="info-box">
                    <strong>Info:</strong> When enabled, the built-in buzzer will beep when any battery's state of charge drops below the threshold.
                </div>
                <div class="modal-buttons">
                    <button type="button" class="btn-secondary" onclick="closeBuzzerModal()">Cancel</button>
                    <button type="submit" class="btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- LCD Display Configuration Modal -->
    <div id="lcdModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>LCD Display Configuration</h3>
            </div>
            <form id="lcdForm">
                <div class="form-group">
                    <label>Font Size (Data Values)</label>
                    <select id="lcdFontSizeInput">
                        <option value="1">Small (1x)</option>
                        <option value="2">Medium (2x)</option>
                        <option value="3">Large (3x)</option>
                    </select>
                    <small>Size of data values (labels stay at 1x for more space)</small>
                </div>
                <div class="form-group">
                    <label>Auto-Scroll Between Devices</label>
                    <select id="lcdAutoScrollInput">
                        <option value="true">Enabled</option>
                        <option value="false">Disabled (Lock to Current)</option>
                    </select>
                    <small>Enable to auto-scroll through devices, disable to stay on one device</small>
                </div>
                <div class="form-group">
                    <label>Page Scroll Rate (seconds)</label>
                    <input type="number" id="lcdScrollRateInput" placeholder="5" value="5" min="1" max="60">
                    <small>Time to display each device before scrolling to next (when auto-scroll enabled)</small>
                </div>
                <div class="form-group">
                    <label>Display Orientation</label>
                    <select id="lcdOrientationInput">
                        <option value="landscape">Landscape (default)</option>
                        <option value="portrait">Portrait</option>
                    </select>
                    <small>Screen orientation mode (requires reboot to apply)</small>
                </div>
                <div class="form-group">
                    <label>Large Display Timeout (seconds)</label>
                    <input type="number" id="lcdLargeTimeoutInput" placeholder="60" value="60" min="0" max="300">
                    <small>Time before entering large display mode (0 = disabled, 10-300 seconds when enabled)</small>
                </div>
                <div class="info-box">
                    <strong>Info:</strong> These settings control how device information is displayed on the M5StickC PLUS2 LCD screen. Changing orientation will reboot the device. Large display mode shows voltage, current, and battery SOC in large font.
                </div>
                <div class="modal-buttons">
                    <button type="button" class="btn-secondary" onclick="closeLCDModal()">Cancel</button>
                    <button type="submit" class="btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let editingAddress = null;

        // Load devices on page load
        window.onload = function() {
            loadDevices();
            loadWiFiStatus();
            loadMQTTStatus();
            loadBuzzerStatus();
            loadLCDStatus();
        };

        function loadDevices() {
            fetch('/api/devices')
                .then(r => r.json())
                .then(devices => {
                    const list = document.getElementById('deviceList');
                    if (devices.length === 0) {
                        list.innerHTML = '<div class="empty-state"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="9" y1="9" x2="15" y2="9"></line><line x1="9" y1="15" x2="15" y2="15"></line></svg><p>No devices configured yet</p></div>';
                    } else {
                        list.innerHTML = devices.map(d => `
                            <div class="device-item">
                                <div class="device-info">
                                    <div class="device-name">${d.name}</div>
                                    <div class="device-address">${d.address}</div>
                                    ${d.encryptionKey ? '<div class="device-key">Encrypted</div>' : '<div class="device-key">Instant Readout</div>'}
                                </div>
                                <div class="device-actions">
                                    <button class="btn-edit" onclick='editDevice(${JSON.stringify(d)})'>Edit</button>
                                    <button class="btn-delete" onclick="deleteDevice('${d.address}')">Delete</button>
                                </div>
                            </div>
                        `).join('');
                    }
                });
        }

        function loadWiFiStatus() {
            fetch('/api/wifi')
                .then(r => r.json())
                .then(wifi => {
                    document.getElementById('currentMode').textContent = wifi.apMode ? 'Access Point' : 'Station';
                    document.getElementById('ipAddress').textContent = wifi.apMode ? 
                        'Connect to Victron-Config' : (wifi.ssid || 'Not configured');
                });
        }

        function openAddDeviceModal() {
            editingAddress = null;
            document.getElementById('modalTitle').textContent = 'Add Device';
            document.getElementById('deviceName').value = '';
            document.getElementById('deviceAddress').value = '';
            document.getElementById('deviceKey').value = '';
            document.getElementById('deviceModal').classList.add('active');
        }

        function editDevice(device) {
            editingAddress = device.address;
            document.getElementById('modalTitle').textContent = 'Edit Device';
            document.getElementById('deviceName').value = device.name;
            document.getElementById('deviceAddress').value = device.address;
            document.getElementById('deviceKey').value = device.encryptionKey || '';
            document.getElementById('deviceModal').classList.add('active');
        }

        function closeDeviceModal() {
            document.getElementById('deviceModal').classList.remove('active');
        }

        function deleteDevice(address) {
            if (confirm('Are you sure you want to delete this device?')) {
                const formData = new URLSearchParams();
                formData.append('address', address);
                
                fetch('/api/devices/delete', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: formData
                })
                .then(r => r.json())
                .then(result => {
                    if (result.success) {
                        loadDevices();
                    } else {
                        alert('Error: ' + result.error);
                    }
                })
                .catch(err => {
                    alert('Failed to delete device: ' + err.message);
                });
            }
        }

        document.getElementById('deviceForm').onsubmit = function(e) {
            e.preventDefault();
            
            const formData = new URLSearchParams();
            formData.append('name', document.getElementById('deviceName').value);
            formData.append('address', document.getElementById('deviceAddress').value.toUpperCase());
            formData.append('encryptionKey', document.getElementById('deviceKey').value);
            
            const url = editingAddress ? '/api/devices/update' : '/api/devices';
            
            // If editing, send the original address to identify which device to update
            if (editingAddress) {
                formData.append('oldAddress', editingAddress);
            }
            
            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: formData
            })
            .then(r => r.json())
            .then(result => {
                if (result.success) {
                    closeDeviceModal();
                    loadDevices();
                } else {
                    alert('Error: ' + result.error);
                }
            })
            .catch(err => {
                alert('Failed to save device: ' + err.message);
            });
        };

        function openWiFiModal() {
            fetch('/api/wifi')
                .then(r => r.json())
                .then(wifi => {
                    document.getElementById('wifiMode').value = wifi.apMode ? 'ap' : 'sta';
                    document.getElementById('wifiSSID').value = wifi.ssid || '';
                    document.getElementById('wifiPassword').value = '';
                    document.getElementById('apPassword').value = wifi.apPassword || '';
                    toggleWiFiMode();
                    document.getElementById('wifiModal').classList.add('active');
                });
        }

        function closeWiFiModal() {
            document.getElementById('wifiModal').classList.remove('active');
        }

        function toggleWiFiMode() {
            const mode = document.getElementById('wifiMode').value;
            document.getElementById('staFields').style.display = mode === 'sta' ? 'block' : 'none';
            document.getElementById('apFields').style.display = mode === 'ap' ? 'block' : 'none';
        }

        document.getElementById('wifiForm').onsubmit = function(e) {
            e.preventDefault();
            
            const formData = new URLSearchParams();
            const mode = document.getElementById('wifiMode').value;
            formData.append('apMode', mode === 'ap' ? 'true' : 'false');
            
            if (mode === 'sta') {
                formData.append('ssid', document.getElementById('wifiSSID').value);
                const pwd = document.getElementById('wifiPassword').value;
                if (pwd) formData.append('password', pwd);
            } else {
                formData.append('apPassword', document.getElementById('apPassword').value);
            }
            
            fetch('/api/wifi', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: formData
            })
            .then(r => r.json())
            .then(result => {
                if (result.success) {
                    alert('Settings saved! Device will restart...');
                    fetch('/api/restart', { method: 'POST' });
                } else {
                    alert('Error: ' + result.error);
                }
            });
        };

        function loadMQTTStatus() {
            fetch('/api/mqtt')
                .then(r => r.json())
                .then(mqtt => {
                    document.getElementById('mqttEnabled').textContent = mqtt.enabled ? 'Enabled' : 'Disabled';
                    document.getElementById('mqttBroker').textContent = mqtt.broker || 'Not configured';
                    document.getElementById('mqttConnected').textContent = mqtt.connected ? 'Connected' : 'Disconnected';
                })
                .catch(err => {
                    document.getElementById('mqttEnabled').textContent = 'Error loading';
                });
        }

        function openMQTTModal() {
            fetch('/api/mqtt')
                .then(r => r.json())
                .then(mqtt => {
                    document.getElementById('mqttEnable').value = mqtt.enabled ? 'true' : 'false';
                    document.getElementById('mqttBrokerAddr').value = mqtt.broker || '';
                    document.getElementById('mqttPort').value = mqtt.port || 1883;
                    document.getElementById('mqttUsername').value = mqtt.username || '';
                    document.getElementById('mqttPassword').value = '';
                    document.getElementById('mqttTopic').value = mqtt.baseTopic || 'victron';
                    document.getElementById('mqttHA').value = mqtt.homeAssistant ? 'true' : 'false';
                    document.getElementById('mqttInterval').value = mqtt.publishInterval || 30;
                    document.getElementById('mqttModal').classList.add('active');
                });
        }

        function closeMQTTModal() {
            document.getElementById('mqttModal').classList.remove('active');
        }

        document.getElementById('mqttForm').onsubmit = function(e) {
            e.preventDefault();
            
            const formData = new URLSearchParams();
            formData.append('enabled', document.getElementById('mqttEnable').value);
            formData.append('broker', document.getElementById('mqttBrokerAddr').value);
            formData.append('port', document.getElementById('mqttPort').value);
            formData.append('username', document.getElementById('mqttUsername').value);
            const pwd = document.getElementById('mqttPassword').value;
            if (pwd) formData.append('password', pwd);
            formData.append('baseTopic', document.getElementById('mqttTopic').value);
            formData.append('homeAssistant', document.getElementById('mqttHA').value);
            formData.append('publishInterval', document.getElementById('mqttInterval').value);
            
            fetch('/api/mqtt', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: formData
            })
            .then(r => r.json())
            .then(result => {
                if (result.success) {
                    closeMQTTModal();
                    loadMQTTStatus();
                    alert('MQTT settings saved successfully!');
                } else {
                    alert('Error: ' + result.error);
                }
            });
        };

        function loadBuzzerStatus() {
            fetch('/api/buzzer')
                .then(r => r.json())
                .then(buzzer => {
                    document.getElementById('buzzerEnabled').textContent = buzzer.enabled ? 'Enabled' : 'Disabled';
                    document.getElementById('buzzerThreshold').textContent = buzzer.threshold + '%';
                })
                .catch(err => {
                    document.getElementById('buzzerEnabled').textContent = 'Error loading';
                    document.getElementById('buzzerThreshold').textContent = 'N/A';
                });
        }

        function loadLCDStatus() {
            fetch('/api/lcd')
                .then(r => r.json())
                .then(lcd => {
                    const fontSizeText = ['Small (1x)', 'Medium (2x)', 'Large (3x)'];
                    document.getElementById('lcdFontSize').textContent = fontSizeText[(lcd.fontSize || 1) - 1] || 'Small (1x)';
                    document.getElementById('lcdAutoScroll').textContent = (lcd.autoScroll !== false) ? 'Enabled' : 'Disabled';
                    document.getElementById('lcdScrollRate').textContent = (lcd.scrollRate || 5) + ' seconds';
                    document.getElementById('lcdOrientation').textContent = lcd.orientation === 'portrait' ? 'Portrait' : 'Landscape';
                    document.getElementById('lcdLargeTimeout').textContent = (lcd.largeTimeout === 0) ? 'Disabled' : lcd.largeTimeout + ' seconds';
                })
                .catch(err => {
                    document.getElementById('lcdFontSize').textContent = 'Error loading';
                    document.getElementById('lcdAutoScroll').textContent = 'Error loading';
                    document.getElementById('lcdScrollRate').textContent = 'Error loading';
                    document.getElementById('lcdOrientation').textContent = 'Error loading';
                    document.getElementById('lcdLargeTimeout').textContent = 'Error loading';
                });
        }

        function openBuzzerModal() {
            fetch('/api/buzzer')
                .then(r => r.json())
                .then(buzzer => {
                    document.getElementById('buzzerEnable').value = buzzer.enabled ? 'true' : 'false';
                    document.getElementById('buzzerThresholdInput').value = buzzer.threshold;
                    document.getElementById('buzzerModal').classList.add('active');
                });
        }

        function closeBuzzerModal() {
            document.getElementById('buzzerModal').classList.remove('active');
        }

        function openLCDModal() {
            fetch('/api/lcd')
                .then(r => r.json())
                .then(lcd => {
                    document.getElementById('lcdFontSizeInput').value = lcd.fontSize || 1;
                    document.getElementById('lcdScrollRateInput').value = lcd.scrollRate || 5;
                    document.getElementById('lcdOrientationInput').value = lcd.orientation || 'landscape';
                    document.getElementById('lcdAutoScrollInput').value = (lcd.autoScroll !== false) ? 'true' : 'false';
                    document.getElementById('lcdLargeTimeoutInput').value = lcd.largeTimeout !== undefined ? lcd.largeTimeout : 60;
                    document.getElementById('lcdModal').classList.add('active');
                });
        }

        function closeLCDModal() {
            document.getElementById('lcdModal').classList.remove('active');
        }

        document.getElementById('buzzerForm').onsubmit = function(e) {
            e.preventDefault();
            
            const formData = new URLSearchParams();
            formData.append('enabled', document.getElementById('buzzerEnable').value);
            formData.append('threshold', document.getElementById('buzzerThresholdInput').value);
            
            fetch('/api/buzzer', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: formData
            })
            .then(r => r.json())
            .then(result => {
                if (result.success) {
                    closeBuzzerModal();
                    loadBuzzerStatus();
                    alert('Buzzer settings saved successfully!');
                } else {
                    alert('Error: ' + result.error);
                }
            });
        };

        document.getElementById('lcdForm').onsubmit = function(e) {
            e.preventDefault();
            
            const largeTimeout = parseInt(document.getElementById('lcdLargeTimeoutInput').value);
            
            // Validate large display timeout (0 = disabled, or 10-300 seconds)
            if (largeTimeout !== 0 && (largeTimeout < 10 || largeTimeout > 300)) {
                alert('Large display timeout must be 0 (disabled) or between 10 and 300 seconds');
                return;
            }
            
            const formData = new URLSearchParams();
            formData.append('fontSize', document.getElementById('lcdFontSizeInput').value);
            formData.append('scrollRate', document.getElementById('lcdScrollRateInput').value);
            formData.append('orientation', document.getElementById('lcdOrientationInput').value);
            formData.append('autoScroll', document.getElementById('lcdAutoScrollInput').value);
            formData.append('largeTimeout', largeTimeout);
            
            fetch('/api/lcd', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: formData
            })
            .then(r => r.json())
            .then(result => {
                if (result.success) {
                    closeLCDModal();
                    loadLCDStatus();
                    if (result.rebootRequired) {
                        alert('LCD settings saved! The device is rebooting to apply the orientation change. Please wait a moment and refresh this page.');
                    } else {
                        alert('LCD settings saved successfully!');
                    }
                } else {
                    alert('Error: ' + result.error);
                }
            });
        };
    </script>
</body>
</html>
